<?php
error_reporting(E_ALL);
// Create connection
$conn = new mysqli('localhost', 'root', '', 'lakshya');
// Check connection
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}
$userType=$_GET['user'];
$data = array();
if(!empty($userType)){
	if($userType=='facility'){
		$sqlNewUser="SELECT f.FacilityID as ids,CONCAT('F',SUBSTR(s.StateName,1,2),SUBSTR(d.DistrictName,1,2), SUBSTR(f.FacilityName,1,3)) as username,f.FacilityName as nameUser 
FROM facilities f 
LEFT JOIN usermapping um on(f.FacilityID=um.FacilityID AND um.FacilityID>0)
inner join states s on(f.StateID=s.StateID)
inner join district d on(f.DistrictID=d.DistrictID)
WHERE um.UsermappingID IS null";
		$roleID='7';
		$field='FacilityID';
	} else if($userType=='state'){
		$sqlNewUser="SELECT s.StateID as ids,CONCAT(SUBSTR(s.StateName,1,2),s.StateID) as username,s.StateName as nameUser 
FROM states s 
LEFT JOIN usermapping um on(s.StateID=um.StateID AND um.StateID>0)
WHERE um.UsermappingID IS null";
	$roleID='4';
	$field='StateID';
	} else if($userType=='district'){
		$sqlNewUser="SELECT d.DistrictID as ids,concat(SUBSTRING(s.StateName,1,3),SUBSTRING(DistrictName,1,3)) as username,d.DistrictName as nameUser 
FROM district d 
LEFT JOIN usermapping um on(d.DistrictID=um.DistrictID AND um.DistrictID>0)
inner JOIN states s on(d.StateID=s.StateID)
WHERE um.UsermappingID IS null";
	$roleID='10';
	$field='DistrictID';
	}	
	$queryTot = $conn->query($sqlNewUser);
	
	while($value = $queryTot->fetch_assoc()){
		$sqlUser="SELECT * FROM `users` where UserName='".trim($value['username'])."'";
		$queryUser = $conn->query($sqlUser);
		if($queryUser->num_rows>'0'){
			$username=preg_replace('/[^A-Za-z0-9]/', '', trim(strtolower($value['username']))).rand(10,100);
		} else {
			$username=preg_replace('/[^A-Za-z0-9]/', '', trim(strtolower($value['username'])));
		}
		$pswrd=$username.rand(10,100);
		$sqlUserInsert="insert into users set UserName='".$username."',Password='".md5($pswrd)."',FirstName='".trim($value['nameUser'])."',IsActive='1',hintpswrd='".$pswrd."'";
		//echo "<br>";
		$queryUserInsert = $conn->query($sqlUserInsert);				
		$userId=$conn->insert_id;
		$sqlUserRoleInsert="insert into userrole set UserID='".$userId."',RoleID='".$roleID."',IsActive='1'";
		//echo "<br>";
		$queryUserRoleInsert = $conn->query($sqlUserRoleInsert);
		$sqlUserRoleInsert="insert into usermapping set UserID='".$userId."',".$field."='".$value['ids']."',IsActive='1'";
		//echo "<br>";
		$queryUserRoleInsert = $conn->query($sqlUserRoleInsert);
		$data[]=$value['nameUser'].'  '.$username.'_'.$pswrd.'_'.$userId;
		echo $value['nameUser'].','.$username.','.$pswrd; echo "</br>";
		
	}
}
        
echo "<pre>"; print_r($data); echo "</pre>"; die;





<?php
error_reporting(E_ALL);
// Create connection
$conn = new mysqli('localhost', 'root', '', 'lakshya');
// Check connection
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}
        $data = array();
		$sqlTot="SELECT * FROM `table 18`";
		$queryTot = $conn->query($sqlTot);
		
		while($value = $queryTot->fetch_assoc()){
			$stateCode=preg_replace('/[^A-Za-z0-9]/', '', trim(strtolower($value['COL 2'])));
			$sqlState="SELECT * FROM `states` where StateCode='".$stateCode."'";
			$queryState = $conn->query($sqlState);
			if($queryState->num_rows=='0'){
				$sqlStateInsert="insert into states set CountryID='1',StateName='".trim($value['COL 2'])."',StateCode='".$stateCode."',IsActive='1'";
				$queryStateInsert = $conn->query($sqlStateInsert);				
				$stateId=$conn->insert_id;
			} else {
				$valueState = $queryState->fetch_assoc();
				$stateId=$valueState['StateID'];
			}
			// for district
			$distCode=preg_replace('/[^A-Za-z0-9]/', '', trim(strtolower($value['COL 3'])));
			$sqlDist="SELECT * FROM `district` inner join states on(states.StateID=district.StateID) where DistrictCode='".$distCode."'";
			$queryDist = $conn->query($sqlDist);
			if($queryDist->num_rows=='0'){
				$sqlDistInsert="insert into district set StateID='".$stateId."',DistrictName='".trim($value['COL 3'])."',DistrictCode='".$distCode."',CensusCode='0',IsHighPriority='0',IsActive='1'";
				$queryDistInsert = $conn->query($sqlDistInsert);				
				$distId=$conn->insert_id;
			} else {
				$valueDist = $queryDist->fetch_assoc();
				$distId=$valueDist['DistrictID'];
			}
			// for facility type
			$sqlType="SELECT * FROM `typedetail` where TypeMasterID='4'and TypeDetailLogicalCode='".trim($value['COL 5'])."'";
			$queryType = $conn->query($sqlType);
			if($queryType->num_rows=='0'){
				$sqlTypeInsert="insert into typedetail set TypeMasterID='4',TypeDetailCode='".trim($value['COL 5'])."',TypeDetailLogicalCode='".trim($value['COL 5'])."',Sequence='1',IsActive='1'";
				$queryTypeInsert = $conn->query($sqlTypeInsert);				
				$typeId=$conn->insert_id;
			} else {
				$valueType = $queryType->fetch_assoc();
				$typeId=$valueType['TypeDetailID'];
			}
			// facility insert
			$facilityCode=preg_replace('/[^A-Za-z0-9]/', '', trim(strtolower($value['COL 4'])));
			echo $sqlFacilityInsert="insert into facilities set FacilityName='".trim($value['COL 4'])."',FacilityNumber='".trim($value['COL 6'])."',StateID='".$stateId."',DistrictID='".$distId."',FacilityTypeDetailID='".$typeId."',Islaqshya='1',IsActive='1',facilityCode='".$facilityCode."'";
			echo "<br>";
			$queryFacilityInsert = $conn->query($sqlFacilityInsert);				
			$FacilityId=$conn->insert_id;
			//echo "<pre>"; print_r($queryState); echo "</pre>";
			$data[]=$stateCode.'_'.$stateId.'  '.$distCode.'_'.$distId.'  '.trim($value['COL 5']).'_'.$typeId.'  '.trim($value['COL 4']).'_'.$FacilityId.'_'.trim($value['COL 6']);
			
		}
echo "<pre>"; print_r($data); echo "</pre>"; die;
		
    
    
    
    delete FROM `usermapping` WHERE `FacilityID` in( SELECT FacilityID FROM `facilities` WHERE `StateID` = 12 ORDER BY `FacilityID` DESC )

delete `userrole` WHERE `UserID` in( SELECT UserID FROM `usermapping` WHERE `FacilityID` in( SELECT FacilityID FROM `facilities` WHERE `StateID` = 12 ORDER BY `FacilityID` DESC ) ) AND UserID>0 ORDER BY `userrole`.`UserID` DESC


delete FROM `users` WHERE `UserID` in( SELECT UserID FROM `usermapping` WHERE `FacilityID` in( SELECT FacilityID FROM `facilities` WHERE `StateID` = 12 ORDER BY `FacilityID` DESC ))

delete FROM `facilities` WHERE `StateID` = 12 ORDER BY `FacilityID` DESC
